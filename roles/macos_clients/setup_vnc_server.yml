#################################################################
# Setup VNC server
# https://aws.amazon.com/premiumsupport/knowledge-center/ec2-mac-instance-gui-access/
#################################################################+
- name: VNC server healthcheck
  wait_for:
    port: 5900
    timeout: 10
  register: result
  ignore_errors: true
  
- name: Enable VNC server
  shell: 'defaults write /var/db/launchd.db/com.apple.launchd/overrides.plist com.apple.screensharing -dict Disabled -bool false'
  when: result.failed is true

- name: Start VNC server
  shell: 'launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist'
  when: result.failed is true

- name: Install pexpect
  pip:
    name: 'pexpect'

- name: Set VNC user password
  ansible.builtin.expect:
    command: /usr/bin/dscl . -passwd /Users/ec2-user
    responses:
        "(.*)New Password:": "{{ vnc_admin_password }}"
  when: result.failed is true

- name: VNC server healthcheck
  wait_for:
    port: 5900
    delay: 10